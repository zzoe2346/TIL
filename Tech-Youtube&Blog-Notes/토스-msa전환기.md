# [토스]"은행 최초 코어뱅킹 MSA 전환기 (feat. 지금 이자 받기)"를 보고

https://youtu.be/amTJyIE1wO0?si=BDRdAN0Ct10jZ31S

# 정리
## 모놀리식의 장점
- 1개의서버 1개의 DB라서 네트워크 구조 단순해 트랜잭션 처리 유리
## 모놀리식의 단점
- 트래픽이 몰렸을 때 특정 코어뱅킹 서버만 스케일아웃하는 전략 불가능
- 한개의 서버러 장애가 하나 발행했는데 다른 기능에 영향을 미칠 수 있어 위험. 단일 장애 지점으로 전 업무가 마비될 수 있다.
- 대량의 트래픽을 안정적으로 운영하는데 한계.
## 마이크로 서비스 아키텍처
- 모바일, 대량 트래픽에 특화된 마으코로서비스 아키텍쳐
- 매일 70만명이 이자 받기 서비스 이용.
- 기존의 모놀리식에서 피크타임 트래픽때문에 문제가 생기기도 함
- 마이크로 서비스 아키텍처를 이용하면 지급 도메인을 스케일아웃 가능
- 장애전파를 막기 가능

## 본격적인 개발 방법
### 아키텍쳐, 도구
쿠버네티스, 스프링부트, 코틀린, JPA, 비동기 메시지 처리와 캐싱위해 카프카, 레디스

> API호출을 통해 비즈니스 의존성을 느슨하게 할 수 있구나. 도메인별로 호출할거니가
### 이자 지급 서버
#### 동시성 제어

- 잔액을 갱신하는 트랜젝션 채널(폰송금, 폰 이자 지금받기, 폰 예금해지, ATM, 각 은행 창구 등) 엄청 많다.
- 일반적으로 사용되는 Redis Global Lock만으로는 은행 시스템에서 동시성 제어 이슈 어렵다(왜?)
- 적절히 동시정 제어 안될 때의 문제
	- 9분부터 설명함. 이거 쉬운코딩에서 강의 했던거
	- select, commit
	- JPA의 @Lock을 추가해서 해결(wait & retry) 디비락쓴거
	- 주의) 락을 잡아야하는 데이터를 명확히 식별, 갱신하는 데이터에 대해서만 락을 획득해야 데드락, 성능저하 얘방가능하다.
#### 성능 개선을 위한 비동기 처리
- 카프카잘 모름 일단 정리
- 카프카로 비동기 트랜잭션 구현
- 카프카로  트랜잭션 분리가 가능한듯...
- (기존)지금 이자 받기 트랜잭션: 80회의 DML -> (개선)지금 이자 받기 트랜잭션: 50회, 세금 DML: 30회
- 세금은 즉시 안해도되서 분리
#### Redis를 활용한 캐싱 전략
##### 기존상황과 개선
- RDB기반 사용
- 하루에 1번만 이자 계산 하면 되는 상황. 즉 1번만 DB i/o하면됨
- 기존에는 이자계산 위한  DB i/o 발생 -> 하루중 처음으로 계좌상세탭에 접근할때에만 DB에 접근하도록 구현 
- 예상되는 이자 조회 결과를 레디스에 캐싱하도록 구현. 하루 2번이상 계좌상세탭에 접근시 미리 레디스에 저자오디있던 이자 계산 결과를 리턴하게함. 그래서 DB 리소스 낭비 예방
- 이자 만료 일자도 하루로 두어 어제의 이자금액이 반환되는 문제도 원천적으로 방지. 매일 자정이후 처음 접근 할때만 캐싱!


#### 마이그래이션방법(검증)
- 데이터정합성이 일치하는지 확인.
- 코어뱅킹서버에서 이자 지급 마이크로서버가 분화. 이 둘의 이자가 동일한지 정합성확인이 요구됨. 
- 거래가 발생시 실시간으로 코어뱅킹과 이자서버에 동시에 api호출. 둘 값이 불일치하면 모니터링 채널에 알림받고 원인학인후 로직 수정
- Stageing환경? 실제 운여환경과 동일하게 구성된 내부 API테스틍ㅇ 황경. 으로 테스트.로직 수정 반복
- 예외케이스 테스트도 실행
	- 잔액 구간 분리, 고객 상태별, 계좌상태 , 출급 입금정지상태 각각의 테스트케이스 

>아 이렇게 모니터링이 완료되면 이제야 이자 api를 완전히 전환시키면디는군.
>모니터링을 엄청나게 하는구나~ 수신개발팀->내부팀원->일부고객->전체고객

#### 왜 이렇게 검증을 빡세게 하는것인가?
API를 한번에 전환했을때 만약 문제가 발생하면 복구 어렵기 때문에. **순차 배포 전략**을 통해 API 트래픽을 점차 늘려가는 형태로 서비스를 전환시킴.
99%-1% -> 90%-10% -> 50%-50% -> 10%-90% -> 0%-100%

**시스템을 중지(빅뱅 배포 방식)시키지않고 배포할수있다**

### 성과
- 코어뱅킹서버로 부터 별도의 서버 구축. 독립적 서비스 가능
- 코어뱅킹서버에 부하가 생겨도 시스템 안정성 향상
- 다른 서버에서도 이 서버 사용할수잇어 더 유연하고 확장성있는 상품 개발이 가능해짐
- 10만->2천 레거시코드 청산 -> 가독성 유지보수업성능개선!!! 
- 코어뱅킹서버 MCI 소요시간->이자 지급 마이크로 서버 API 소요시간
	- (평균소요시간) 250ms -> (평균소요시간)7ms, 40배개선 
	- (최대소요시간) 1.72초 -> (최대소요시간) 11ms, 약 170배 개선

### 성과요약
1. 코어뱅킹 계정계 시스템의 세대전환
2. 오픈소스 기반의 개발환경변화에 따른 개발 유연성 및 확장성 증가
3. 지금 이자 받기 거래의 성능 170배 개선
4. 계정계 서버로 부터 독립적인 서브를 구축함으로서 안정성 증가
5. 지금 이자 받기 피크타임 트래픽에도 개별적으로 이자 지급 서버 스케일 아웃 가능
6. 도메인 단위로 분리해 효율적 MSA코어뱅킹 시스템 구축
7. 빅뱅 배포방식 탈피해 무중단 시스템 전환 가능
# 후기
지금 이자 받기 서비스 자주 쓰는데 이거에 대한 내용이라 재미있었음.
서비스 되는 도메인영역을 잘 파악하는게 정말 중요할듯. 모놀리식에 포함된 기능들을 마이크로서비스로 추출할때 도메인 모르면 제대로 기능 분리에 어려움을 겪을듯.